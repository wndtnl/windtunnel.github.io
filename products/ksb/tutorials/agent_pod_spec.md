# Adjust Agent Pod Spec

- [Introduction](/tutorials/agent_pod_spec.md?id=introduction)
- [Use Case: Environment Variables](/tutorials/agent_pod_spec.md?id=use-case-environment-variables)
- [Use Case: Addition of Volumes](/tutorials/agent_pod_spec.md?id=use-case-addition-of-volumes)
- [Use Case: Node Assignment](/tutorials/agent_pod_spec.md?id=use-case-node-assignment)
- [Use Case: Linked Containers](/tutorials/agent_pod_spec.md?id=use-case-linked-containers)
- [Use Case: Custom Resources](/tutorials/agent_pod_spec.md?id=use-case-custom-resources)
- [Use Case: DNS Config](/tutorials/agent_pod_spec.md?id=use-case-dns-config)

## Introduction

As discussed on the [instance administration](/administration/instances/instances.md?id=administration) page, the 'Spec merge'
field of the instance definition allows merging custom YAML with the Pod specification as generated by the plugin.

In this tutorial a number of common use-cases are presented which can be handled with the 'Spec merge' field,
illustrated with example YAML snippets for quick reference.

## Use Case: Environment Variables

Environment variables can be added to the agent container as defined by the plugin, having the fixed name 'bamboo-agent'.
The snippet below shows the required value of the 'Spec merge' field to add a single variable by value:

```
containers:
  - name: bamboo-agent
    env:
      - name: BUILD_ENVIRONMENT
        value: Production
```

Of course, variables can be loaded by reference from config maps or secrets as well.

## Use Case: Addition of Volumes

Addition of one or more volumes can be useful to mount previously defined (kubernetes) secrets or large volumes of data required by
the build process. The volume must be defined before it can be mounted on the 'bamboo-agent' container, as shown below:

```
containers:
  - name: bamboo-agent
    volumeMounts:
    - name: secrets
      mountPath: "/etc/secrets"
      readOnly: true
volumes:
    - name: secrets
      secret:
        secretName: build-secrets
```

## Use Case: Node Assignment

Instances can be assigned to specific cluster nodes using [Tolerations](https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/),
[Affinity](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity) and/or a
[NodeSelector](https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector). The snippet below shows an example
value for the 'Spec merge' field using tolerations:

```
tolerations:
  - key: "project"
    operator: "Equal"
    value: "website"
    effect: "NoSchedule"
  - key: "team"
    operator: "Exists"
    effect: "NoSchedule"
```

## Use Case: Linked Containers

The 'Spec merge' field can be used to define additional containers which are co-hosted in the Bamboo agent Pod. Such containers
can provide additional services used by the build pipeline(s): databases, headless browsers...

The snippet below shows the 'Spec merge' field value for running an (unprivileged) nginx proxy as an additional container:

```
containers:
  - name: nginx
    image: nginxinc/nginx-unprivileged
    imagePullPolicy: Always
    restartPolicy: Always
```

From a build script running on this instance, we can easily communicate with this linked container over localhost:

```
wget -v http://127.0.0.1:8080
```

## Use Case: Custom Resources

The instance create dialog allows specification of the instance size in terms of fixed buckets of CPU and memory.
The options for this field are quite limited, and in some cases custom values are desired.

The 'Spec merge' field can be used to override the values as set by the instance size field, as shown below.
When a resources block is provided like this, the actual value of the instance size field will not matter as the 'Spec merge' is applied last. 

```
containers:
  - name: bamboo-agent
    resources:
      limits:
        cpu: 750m
        memory: 1Gi
      requests:
        cpu: 500m
        memory: 725Mi
```

# Use Case: DNS Config

The default DNS configuration as generated by the plugin looks as follows:

```
dnsPolicy: None
dnsConfig:
  nameservers:
    - 8.8.8.8
    - 8.8.4.4
```

This works well out of the box for environments where the Bamboo server is hosted on a publicly resolvable address.
If not, the default should and can be overwritten with a custom configuration specified in the 'Spec merge' field. An example is shown below.

> Note that DNS configuration is performed on the pod level and not on the level of the containers.

```
dnsPolicy: ClusterFirst
dnsConfig: 
  nameservers: 
    - 10.10.10.10
    - 10.10.10.11
  searches: 
    - domain.net
```